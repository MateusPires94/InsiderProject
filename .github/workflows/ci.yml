name: CI Build, Test and Push

on:
  push:
    tags:
      - 'model*'  # Executa somente para tags como model_v1, model_titanic etc

jobs:
  build-test-push:
    runs-on: ubuntu-latest

    env:
      MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
      MLFLOW_MODEL_NAME: ${{ secrets.MLFLOW_MODEL_NAME }}
      MLFLOW_MODEL_ALIAS: ${{ secrets.MLFLOW_MODEL_ALIAS }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      MLFLOW_S3_ENDPOINT_URL: ${{ secrets.MLFLOW_S3_ENDPOINT_URL }}
      MONGO_URI: ${{ secrets.MONGO_URI }}
      MONGO_DB_NAME: ${{ secrets.MONGO_DB_NAME }}
      MONGODB_HISTORY_COLLECTION: ${{ secrets.MONGODB_HISTORY_COLLECTION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build FastAPI Docker image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-image:${{ github.ref_name }} ./fastapi

      - name: Run tests inside container
        run: |
          docker run --rm \
            -e MLFLOW_TRACKING_URI \
            -e MLFLOW_MODEL_NAME \
            -e MLFLOW_MODEL_ALIAS \
            -e AWS_ACCESS_KEY_ID \
            -e AWS_SECRET_ACCESS_KEY \
            -e MLFLOW_S3_ENDPOINT_URL \
            -e MONGO_URI \
            -e MONGO_DB_NAME \
            -e MONGODB_HISTORY_COLLECTION \
            ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-image:${{ github.ref_name }} \
            bash -c "pytest tests -v"

      - name: Push Docker image to Docker Hub
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/fastapi-image:${{ github.ref_name }}
